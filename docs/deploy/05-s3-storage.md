# 05 — План миграции медиа на Timeweb S3 (когда Supabase Storage станет тесным)

Этот документ описывает **decision‑complete** план миграции изображений (hero + gallery) из Supabase Storage в **Timeweb Cloud S3‑совместимое объектное хранилище**.

Текущий MVP остаётся на Supabase (DB/Auth/Storage). Этот план нужен, чтобы:
- не упереться в лимиты Supabase Storage на Free/Starter;
- получить **стабильные URL** (лучше кэширование) и независимость от Supabase Storage;
- мигрировать **без простоя** и с быстрым rollback.

---

## 1) Когда мигрировать (триггеры)

Миграцию имеет смысл делать, когда выполняется хотя бы один пункт:
- Supabase Storage приближается к лимиту (например, **70–80%** заполнения).
- Начинаешь добавлять больше моделей/фото (например, **> 50 моделей** или **> 250 фото**).
- Упираешься в egress/скорость отдачи медиа.
- Хочешь стабильный домен медиа (например, `media.example.com`) и долгий кэш `Cache-Control`.

Что изменится после миграции:
- провайдер хранения файлов (Supabase → Timeweb S3);
- формат URL изображений (signed/transform Supabase → публичные URL S3 или домен бакета);
- кэширование (станет проще сделать “immutable” URL с долгим TTL);
- (опционально) политика доступа (public bucket vs private/presigned).

---

## 2) Выбор режима бакета (под текущий кейс)

Ты ранее подтвердил, что **конфиденциальных изображений нет**, и всё загруженное по смыслу можно считать публичным.

### Рекомендуемый режим для MVP: Public bucket
- Плюсы: **стабильные URL**, простой показ на публичке, лучший кэш, меньше server‑логики.
- Минусы: если кто-то узнает ссылку на файл — он сможет открыть её (это ок для “всё публично”).

### Альтернатива на будущее (если захочешь скрывать “неопубликованное”)
1) Private bucket + **presigned GET**:
   - показывать “draft” медиа через временные ссылки;
   - публиковать модель → выдавать/кэшировать ссылки заново.
2) Private bucket + policy по префиксам:
   - `public/*` читать всем, `draft/*` — только админам;
   - при publish перемещать из `draft/` в `public/`.

---

## 3) Настройка Timeweb S3 (инфраструктура)

### 3.1 Создать бакет
Timeweb Cloud → S3 Storage:
- создать бакет (имя, регион);
- для текущего кейса выбрать **public**;
- (рекомендуется) сразу выставить **лимит трафика/расходов** в панели, чтобы не было неожиданной оплаты.

### 3.2 Ключи доступа + endpoint/region
Сохранить параметры для серверной части:
- `S3_ENDPOINT` (для Timeweb обычно `https://s3.twcstorage.ru`)
- `S3_REGION` (обычно `ru-1`)
- `S3_BUCKET`
- `S3_ACCESS_KEY_ID`
- `S3_SECRET_ACCESS_KEY`

Все эти переменные должны быть **server-only** (не `NEXT_PUBLIC_*`).

### 3.3 (Опционально) Привязать домен к бакету
Если хочешь красивые URL:
- завести `media.example.com`
- привязать домен к бакету в Timeweb

Тогда `TIMEWEB_S3_PUBLIC_BASE_URL` будет вида `https://media.example.com`.

### 3.4 CORS (если понадобится прямой upload из браузера)
Если в будущем будешь загружать в S3 **напрямую с клиента** (без server actions), нужно:
- разрешить `PUT/POST` для домена админки (`https://example.com`) и `http://localhost:3000`
- разрешить нужные заголовки (`Content-Type`, `Cache-Control`, `x-amz-*`)

Для текущего плана (upload через сервер) CORS не обязателен.

---

## 4) Изменения в коде (будущая реализация миграции)

Цель — сделать так, чтобы:
- можно было переключать провайдера **env‑флагом**;
- приложение умело читать медиа из **двух источников** одновременно (для миграции без простоя);
- удаление/реордер/hero‑replace корректно работали для каждого провайдера.

### 4.1 Абстракция провайдера медиа
Добавить интерфейс (пример):
- `uploadObject(key, file, contentType, cacheControl) -> void`
- `removeObjects(keys[]) -> void`
- `getPublicUrl(key) -> string` *(для public bucket)*

Реализации:
- `SupabaseStorageProvider` (текущее поведение)
- `TimewebS3Provider` (AWS SDK v3 с кастомным endpoint)

### 4.2 Env‑переключатель
Добавить env:
- `MEDIA_UPLOAD_PROVIDER=supabase|timeweb_s3` (default: `supabase`)
- `TIMEWEB_S3_*` (endpoint/region/bucket/keys/baseUrl)

### 4.3 `next/image` allowlist
В `next.config.ts` добавить `remotePatterns`:
- для `s3.twcstorage.ru` (если используешь прямые URL)
- и/или для `media.example.com` (если привязал домен к бакету)

### 4.4 (Опционально) расширение таблицы `asset_media`
Чтобы поддержать “два провайдера” одновременно, понадобится минимум:
- `provider` (`'supabase'|'timeweb_s3'`) — где лежит файл

Опционально:
- `public_url` (если хочешь сохранять уже готовую ссылку; обычно достаточно `provider + path`).

---

## 5) Миграция существующих файлов (без простоя)

### 5.1 Подготовка (релиз 1)
1) Добавить `asset_media.provider` (default: `supabase`).
2) На чтение:
   - если `provider='supabase'` → строить URL как сейчас (Supabase signed/transform).
   - если `provider='timeweb_s3'` → строить URL через `TIMEWEB_S3_PUBLIC_BASE_URL + '/' + path`.
3) На загрузку:
   - загрузки остаются в Supabase (MVP не меняем).

**Результат:** система умеет показывать “смешанные” медиа, но пока все данные в Supabase.

### 5.2 Копирование объектов (релиз 2: миграционный скрипт)
Скрипт выполняется вручную/в CI (на твоей машине, не в прод‑контейнере):
1) Выгрузить список объектов из Supabase:
   - можно через `storage.objects` или через Supabase Storage API;
   - нужен список `asset_media.path`.
2) Для каждого `path`:
   - скачать объект из Supabase (admin/service роль)
   - загрузить в Timeweb S3 по тому же `path`
   - выставить `Cache-Control` (рекомендуемо `public, max-age=31536000, immutable`, т.к. имена у тебя UUID)
3) После успешной загрузки пачки:
   - обновить строки `asset_media.provider='timeweb_s3'` для этих `path`

Правило безопасности:
- **не удалять** данные из Supabase, пока не завершишь валидацию.

### 5.3 Валидация (после копирования)
Чеклист:
- Публичка:
  - `/models` — превью отображаются
  - `/models/[document_id]` — hero + галерея отображаются
- Админка:
  - `/admin/models/[id]` — превью отображаются
  - удаление медиа удаляет правильный объект
  - замена hero работает

### 5.4 Переключение новых загрузок (релиз 3)
- Поставить `MEDIA_UPLOAD_PROVIDER=timeweb_s3` в Timeweb env vars.
- Новые загрузки будут попадать в S3, старые уже мигрированы.

### 5.5 Очистка (релиз 4)
Только после успешной валидации:
- удалить объекты из Supabase Storage (по `path`), которые уже в S3
- проверить, что Supabase Storage usage снизился

---

## 6) Rollback (быстро и безопасно)

Если после переключения что-то пошло не так:
1) Вернуть `MEDIA_UPLOAD_PROVIDER=supabase`.
2) (Если нужно) временно оставить `provider` строк как есть:
   - чтение работает из обоих провайдеров;
   - можно точечно вернуть `provider='supabase'` для проблемных строк.

Rollback возможен, пока данные **не удалены** из Supabase.

---

## 7) Риски и контроль

### 7.1 Кэширование и расходы
- Стабильные URL + `Cache-Control: immutable` снижают egress и ускоряют сайт.
- Рекомендуется настроить лимиты расходов/трафика в панели Timeweb.

### 7.2 Оптимизация изображений
Если захочешь экономить storage без сильной потери качества — лучше делать это **до загрузки** (ручная подготовка или отдельный пайплайн), а не “на лету” на сервере.

### 7.3 Мониторинг
Минимум:
- периодически проверять объём Supabase Storage и трафик (egress)
- следить за ошибками загрузок/удалений медиа (логирование в app)

